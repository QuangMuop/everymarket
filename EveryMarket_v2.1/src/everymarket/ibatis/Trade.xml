<?xml version="1.0" encoding="UTF-8"?>


<!DOCTYPE sqlMap      
    PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"      
    "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<!-- sqlMapConfig초기화에서 에러나서 임시로 만든 sql파일 ㅋㅋ -->

<sqlMap namespace="Trade">

	<typeAlias alias="Trade" type="everymarket.model.Trade" />

	<!-- 구매요청 시 거래 내역 생성   -->
	<insert id="insertTrade" parameterClass="java.util.HashMap">
		insert into trade(
			t_id, t_buyer, p_id, t_date, t_status, t_del_number
		)values(t_id_seq.NEXTVAL, #m_id#, #p_id#, sysdate, 0, 0)
	</insert>
	
	<!-- 판매자 아이디 업데이트 -->
	<update id="update_t_seller" parameterClass="int">
		update trade set
			t_seller = (select p.m_id from member m join product p on m.m_id = p.m_id where p.p_id=#p_id#)
	</update>

	<select id="getM_nameByP_id" resultClass="String">
		select m.m_name
		from member m
		  join trade t
		  on m.m_id = t.t_buyer
		where t.p_id = #p_id#
	</select>


	<select id="getBuyingTrade" resultClass="Trade">
		select t.t_id,
		t.t_buyer, t.p_id, t.t_date, t.t_status, t.t_del_number,
		p.p_name,
		p.p_price from
		trade t
		join product p on t.p_id = p.p_id
		where
		t.t_buyer =
		#m_id# and t.t_status >= 0
	</select>

	<select id="getSellingTrade" resultClass="Trade">
		select t.t_id,
		t.t_buyer, t.p_id, t.t_date, t.t_status, t.t_del_number,
		p.p_name,
		p.p_price from
		trade t
		join product p on t.p_id = p.p_id
		where
		p.m_id =
		#m_id# and t.t_status >= 0
	</select>

	<!-- 운송번호입력과 거래상태를 바꿔주는 쿼리문 -->
	<update id="update_deliver_number">
		update trade set t_status = #t_status#, t_del_number
		=
		#d_number# where t_id = #t_id#
	</update>

	<!-- 배송 완료됐을시 status바꿔주기 -->
	<update id="update_deliver_ok">
		update trade set t_status = #t_status# where t_id = #t_id#
	</update>



</sqlMap>
